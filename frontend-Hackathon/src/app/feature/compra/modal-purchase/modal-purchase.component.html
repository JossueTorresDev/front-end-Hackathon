<div class="modal-container mat-elevation-z2">
  <h2 mat-dialog-title class="modal-title">{{ modalTitle }}</h2>


  <mat-dialog-content>
    <form [formGroup]="purchaseForm" (ngSubmit)="onSubmit()">


      <!-- Datos del proveedor o comprador -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Nombre</mat-label> 
          <input matInput formControlName="name" required>
          <mat-icon matPrefix>person</mat-icon>
          <mat-error *ngIf="purchaseForm.get('name')?.hasError('required') || purchaseForm.get('name')?.hasError('whitespace')">
            Nombre es requerido y no puede estar vacío o solo espacios
          </mat-error>
          <mat-error *ngIf="purchaseForm.get('name')?.hasError('pattern')">
            Solo letras y espacios.
          </mat-error>
        </mat-form-field>


        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Apellido</mat-label>
          <input matInput formControlName="lastName" required>
          <mat-icon matPrefix>person</mat-icon>
          <mat-error *ngIf="purchaseForm.get('lastName')?.hasError('required') || purchaseForm.get('lastName')?.hasError('whitespace')">
            Apellido es requerido y no puede estar vacío o solo espacios
          </mat-error>
          <mat-error *ngIf="purchaseForm.get('lastName')?.hasError('pattern')">
            Solo letras y espacios.
          </mat-error>
        </mat-form-field>
      </div>


      <div class="form-row">
  <mat-form-field appearance="outline" class="half-width">
    <mat-label>Teléfono</mat-label>
    <input matInput formControlName="phone" required>
    <mat-icon matPrefix>phone</mat-icon>

    <mat-error *ngIf="purchaseForm.get('phone')?.hasError('required')">
      Teléfono es requerido
    </mat-error>

    <mat-error *ngIf="purchaseForm.get('phone')?.hasError('pattern')">
      El numero debe Empezar con 9 y ingresar solo numeros
    </mat-error>

    <mat-error *ngIf="purchaseForm.get('phone')?.hasError('maxlength')">
      Debe tener máximo 9 dígitos
    </mat-error>
  </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Dirección</mat-label>
          <input matInput formControlName="address" required>
          <mat-icon matPrefix>home</mat-icon>
          <mat-error *ngIf="purchaseForm.get('address')?.hasError('required') || purchaseForm.get('address')?.hasError('whitespace')">
            Dirección es requerida y no puede estar vacía o solo espacios
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Fecha y método de compra -->
  <div class="form-row">
  <mat-form-field appearance="outline" class="half-width">
    <mat-label>Fecha de Compra</mat-label>
    <input matInput [matDatepicker]="purchasePicker" formControlName="datePurchase" required>
    <mat-icon matPrefix>event</mat-icon>
    <mat-datepicker-toggle matSuffix [for]="purchasePicker"></mat-datepicker-toggle>
    <mat-datepicker #purchasePicker></mat-datepicker>
    <mat-error *ngIf="purchaseForm.get('datePurchase')?.hasError('required')">
      Fecha es requerida
    </mat-error>
  </mat-form-field>
</div>


      <!-- Detalles de la compra -->
      <div class="details-container">
        <div class="details-header">
          <h3><mat-icon>shopping_cart</mat-icon> Detalles de la Compra</h3>
          <button type="button" mat-mini-fab color="primary" (click)="addDetail()" aria-label="Agregar producto">
            <mat-icon>add</mat-icon>
          </button>
        </div>


        <div formArrayName="purchaseDetails" class="details-list">
          <div *ngFor="let detail of detailsFormArray.controls; let i = index" [formGroupName]="i" class="detail-row">


            <mat-form-field appearance="outline" class="detail-product">
              <mat-label>Producto</mat-label>
              <mat-select formControlName="productId" required>
                <mat-option *ngFor="let p of products" [value]="p.id">{{ p.name }}</mat-option>
              </mat-select>
              <mat-error *ngIf="detailsFormArray.at(i).get('productId')?.hasError('required')">
                Producto es requerido
              </mat-error>
            </mat-form-field>


            <mat-form-field appearance="outline" class="detail-amount">
              <mat-label>Cantidad</mat-label>
              <input matInput type="number" formControlName="productQuantity" min="1" required>
              <mat-error *ngIf="detailsFormArray.at(i).get('productQuantity')?.hasError('required')">
                Cantidad es requerida
              </mat-error>
              <mat-error *ngIf="detailsFormArray.at(i).get('productQuantity')?.hasError('min')">
                Debe ser mayor a 0
              </mat-error>
            </mat-form-field>


            <mat-form-field appearance="outline" class="detail-price">
              <mat-label>Precio de Compra</mat-label>
              <input matInput type="number" formControlName="purchasePrice" min="0" required>
              <span matPrefix>S/&nbsp;</span>
              <mat-error *ngIf="detailsFormArray.at(i).get('purchasePrice')?.hasError('required')">
                Precio es requerido
              </mat-error>
              <mat-error *ngIf="detailsFormArray.at(i).get('purchasePrice')?.hasError('min')">
                Debe ser ≥ 0.1
              </mat-error>
            </mat-form-field>


            <!-- Subtotal -->
            <div class="detail-total">
              {{ detailsFormArray.at(i).get('productQuantity')?.value * detailsFormArray.at(i).get('purchasePrice')?.value | currency:'PEN':'symbol':'1.2-2':'es-PE'  }}
            </div>


            <div class="detail-actions">
              <button type="button" mat-icon-button color="warn" (click)="removeDetail(i)"
                      [disabled]="detailsFormArray.length <= 1"
                      aria-label="Eliminar producto">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>


        <!-- Total general -->
        <div class="sale-total">
          <span class="total-label">Total:</span>
          <span class="total-amount">${{ calculateTotal() | number:'1.2-2' }}</span>
        </div>
      </div>


    </form>
  </mat-dialog-content>


  <mat-dialog-actions align="end">
    <button mat-stroked-button color="basic" (click)="cancel()">
      <mat-icon>cancel</mat-icon> Cancelar
    </button>
    <button mat-raised-button color="primary" [disabled]="purchaseForm.invalid || isLoading" (click)="onSubmit()">
      <mat-icon *ngIf="!isLoading">save</mat-icon>
      <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
      {{ isEditing ? 'Actualizar' : 'Guardar' }}
    </button>
  </mat-dialog-actions>
</div>
