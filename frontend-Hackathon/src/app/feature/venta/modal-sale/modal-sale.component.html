<div class="modal-container mat-elevation-z2">
  <h2 mat-dialog-title class="modal-title">{{ modalTitle }}</h2>

  <mat-dialog-content>
    <form [formGroup]="saleForm" (ngSubmit)="onSubmit()">

      <!-- Cliente -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Cliente</mat-label>
          <mat-select formControlName="customerId" required>
            <mat-option *ngFor="let customer of customers" [value]="customer.id">
              {{ customer.name }} {{ customer.lastName }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>person</mat-icon>
          <mat-error *ngIf="saleForm.get('customerId')?.hasError('required')">
            Cliente es requerido
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Fecha y método de pago -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Fecha de Venta</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="dateSale"
            [max]="today" [min]="minDate" required>
          <mat-icon matPrefix>event</mat-icon>
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <mat-error *ngIf="saleForm.get('dateSale')?.hasError('required')">
            Fecha es requerida
          </mat-error>
          <mat-error *ngIf="saleForm.get('dateSale')?.hasError('futureDate')">
            No se permiten fechas futuras
          </mat-error>
          <mat-error *ngIf="saleForm.get('dateSale')?.hasError('tooOld')">
            Solo se permite una fecha dentro de los últimos 7 días
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Método de Pago</mat-label>
          <mat-select formControlName="paymentMethod" required>
            <mat-option *ngFor="let method of paymentMethods" [value]="method.value">
              {{ method.viewValue }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>payment</mat-icon>
          <mat-error *ngIf="saleForm.get('paymentMethod')?.hasError('required')">
            Método de pago es requerido
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Detalles -->
      <div class="details-container">
        <div class="details-header">
          <h3><mat-icon>shopping_cart</mat-icon> Detalles de la Venta</h3>
          <button type="button" mat-mini-fab color="primary" (click)="addDetail()" aria-label="Agregar producto">
            <mat-icon>add</mat-icon>
          </button>
        </div>

        <div formArrayName="saleDetails" class="details-list">
          <div *ngFor="let detail of detailsFormArray.controls; let i = index" [formGroupName]="i" class="detail-row">
            <mat-form-field appearance="outline" class="detail-product">
              <mat-label>Producto</mat-label>
              <mat-select formControlName="productId" required>
                <mat-option *ngFor="let p of products" [value]="p.id">{{ p.name }}</mat-option>
              </mat-select>
              <mat-error *ngIf="detailsFormArray.at(i).get('productId')?.hasError('required')">
                Producto es requerido
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="detail-amount">
              <mat-label>Cantidad</mat-label>
              <input matInput type="number" formControlName="amount" min="1" required>
              <mat-error *ngIf="detailsFormArray.at(i).get('amount')?.hasError('required')">
                Cantidad es requerida
              </mat-error>
              <mat-error *ngIf="detailsFormArray.at(i).get('amount')?.hasError('min')">
                Debe ser mayor a 0
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="detail-price">
              <mat-label>Precio unitario</mat-label>
              <input matInput type="number" formControlName="saleCost" min="0" required readonly>
              <span matPrefix>S/&nbsp;</span>
              <mat-error *ngIf="detailsFormArray.at(i).get('saleCost')?.hasError('required')">
                Precio es requerido
              </mat-error>
              <mat-error *ngIf="detailsFormArray.at(i).get('saleCost')?.hasError('min')">
                Debe ser ≥ 0
              </mat-error>
            </mat-form-field>

            <div class="detail-total">
  {{ detailsFormArray.at(i).get('amount')?.value * detailsFormArray.at(i).get('saleCost')?.value | currency:'PEN':'symbol':'1.2-2':'es-PE' }}
</div>

            <div class="detail-actions">
              <button type="button" mat-icon-button color="warn" (click)="removeDetail(i)" 
                      [disabled]="detailsFormArray.length <= 1"
                      aria-label="Eliminar producto">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>

        <!-- Total -->
        <div class="sale-total">
          <span class="total-label">Total:</span>
          <span class="total-amount">
  {{ calculateTotal() | currency:'PEN':'symbol':'1.2-2':'es-PE' }}
</span>
        </div>
      </div>

    </form>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-stroked-button color="basic" (click)="cancel()">
      <mat-icon>cancel</mat-icon> Cancelar
    </button>
    <button mat-raised-button color="primary" [disabled]="saleForm.invalid || isLoading" (click)="onSubmit()">
      <mat-icon *ngIf="!isLoading">save</mat-icon>
      <mat-icon *ngIf="isLoading">
        <mat-spinner diameter="20"></mat-spinner>
      </mat-icon>
      {{ isEditing ? 'Actualizar' : 'Guardar' }}
    </button>
  </mat-dialog-actions>
</div>